<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Project Map</title>

  <!-- Font Awesome CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Leaflet CSS / JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- XLSX for reading .xls / .xlsx / .xlsm -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* 基本リセット */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* 全体レイアウト */
    body {
      font-family: Arial, sans-serif;
      min-height: 100vh;
      overflow: hidden; 
      display: flex;
      flex-direction: column;
    }

    /* 共通メニュースタイル */
    .menu {
      position: fixed;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease-in-out;
      z-index: 3002;
    }


    /* 地域選択ドロップダウンのスタイル */
    .region-select-container select {
      width: 100%;
      padding: 0px;
      border: 1px solid grey;
      border-radius: 15px;
      font-size: 16px;
    }

    /* メディアクエリ: モバイル */
    @media screen and (max-width: 768px) {
      /* メニューコンテナのスタイル */
      #menuContainer {
        position: fixed;
        bottom: -66%;
        left: 0;
        width: 100%;
        height: 70%;
        border-radius: 15px 15px 0 0;
        background: rgba(255, 255, 255, 0.95);
        transition: transform 0.3s ease-out, bottom 0.3s ease-out;
        z-index: 1000;
      }

      /* メニューの状態 */
      #menuContainer.closed { bottom: -66%; }
      #menuContainer.half { bottom: -30%; }
      #menuContainer.full { bottom: 0; }

      /* ドラッグハンドル */
      .menu-header {
        width: 100%;
        height: 30px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: grab;
      }

      .drag-handle {
        width: 50px;
        height: 5px;
        background: #999;
        border-radius: 2.5px;
      }

      /* メニュートグルボタンを非表示に */
      .menu-toggle { display: none !important; }
      
      .zoom-container {
        bottom: 50px;
      }
      
      /* Transition for moving the container */
      .zoom-container.moved-left {
        right: auto;
        left: 11px;
      }      
      
    }

    /* メディアクエリ: デスクトップ/タブレット */
    @media screen and (min-width: 769px) {
      #menuContainer {
        top: 0;
        left: 0;
        width: 400px;
        height: 100%;
        border-radius: 0 15px 15px 0;
        transform: translateX(-400px);
        transition: transform 0.3s ease-out;
      }

      #menuContainer.open { transform: translateX(0); }

      /* メニュートグルボタンのスタイル */
      .menu-toggle {
        position: fixed;
        top: 34px;
        left: 15px;
        transform: translateY(-50%);
        background: none;
        font-size: 30px;
        color: #555;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        z-index: 1001;
        transition: color 0.3s;
      }

      .menu-toggle:hover { color: #333; }

      /* メニューコンテンツ */
      .menu-content {
        width: 100%;
        height: 100%;
        background: white;
        overflow-y: auto;
        padding: 10px;
      }

      /* PCではメニューヘッダーを非表示 */
      .menu-header { display: none !important; }
      
      .zoom-container {
        bottom: 20px;
      }
      
      /* Transition for moving the container */
      .zoom-container.moved-left {
        right: auto;
        left: 16px;
      }  
      
    }

    /* その他のスタイル */
    #top-bar {
      background: transparent;
      margin-left: 5px;
      padding: 5px 5px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* top-bar の入力欄（info-iconなし） */
    #top-bar .search-container input {
        padding: 6px 35px 6px 35px;
        border: 1px solid grey;
        border-radius: 15px;
        font-size: 16px;
    }
    
    .union-icon {
      position: absolute;
      left: 8px;
      top: 18%;
      transform: translateY(-0%);
      width: 20px;
      height: 20px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s, transform 0.3s;
    }

    .union-icon:hover {
      opacity: 1;
      transform: scale(1.2);
    }        
    
    /* ドロップダウンリストのスタイル */
    .region-dropdown {
      position: absolute;
      top: 40px; /* union-iconの位置に応じて調整 */
      left: 0px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      display: none; /* 初期状態では非表示 */
      z-index: 3004;
    }

    .region-dropdown.show {
      display: block;
    }

    .region-dropdown ul {
      list-style: none;
      padding: 10px;
      margin: 0;
    }

    .region-dropdown li {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .region-dropdown li:hover,
    .region-dropdown li:focus {
      background-color: #f0f0f0;
      border: none;
      border-radius: 10px;
    }
    
    /* Wikipedia Infobox Parser Styles (追加) */
    /* Infobox全体のスタイル */
    table.infobox {
      width: 100%;
      max-width: 100%;
      border: 1px solid #aaa;
      border-collapse: collapse;
      background-color: #f9f9f9;
      font-family: Arial, sans-serif;
      margin-top: 10px;
    }

    /* 見出しセル（th）のスタイル */
    table.infobox th {
      background-color: #e9ecef;
      color: #333;
      padding: 8px;
      text-align: left;
      vertical-align: top;
      width: 30%;
      border-bottom: 1px solid #ddd;
      font-size: 1em;
    }

    /* データセル（td）のスタイル */
    table.infobox td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      font-size: 0.95em;
      color: #555;
    }

    /* 最後の行のボーダーを除去 */
    table.infobox tr:last-child td,
    table.infobox tr:last-child th {
      border-bottom: none;
    }

    /* レスポンシブ対応 */
    @media (max-width: 769px) {
      table.infobox th, table.infobox td {
        display: block;
        width: 100%;
      }
      table.infobox th {
        background-color: #f1f1f1;
      }
    }

    /* その他のスタイル調整（必要に応じて追加） */
    /* リンクの色を変更 */
    table.infobox a {
      color: #007bff;
      text-decoration: none;
    }
    table.infobox a:hover {
      text-decoration: underline;
    }

    /* 画像を中央に配置 */
    table.infobox img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
    }

    /* 
    Infobox検索コンテナのスタイル まだ必要？
      .infobox-search-container {
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        margin: 10px;
        z-index: 3003;
      }

      .infobox-search-container input {
        width: calc(100% - 100px);
        padding: 8px;
        border: 1px solid grey;
        border-radius: 5px;
        font-size: 16px;
      }

      .infobox-search-container button {
        width: 80px;
        padding: 8px;
        margin-left: 10px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      .infobox-search-container button:hover {
        background-color: #218838;
      }
    */

    /* Infobox表示コンテナのスタイル */
    #infobox-container {
      padding: 10px;
      background-color: transparent;
      border-radius: 10px;
      max-width: 100%;
      margin: 10px auto;
      overflow-y: auto; /* 縦方向スクロールを追加 */
      z-index: 3003; /* 他の要素より高いz-indexを設定 */

      /* スクロールバーのスタイルをカスタマイズする場合（オプション） */
      /* Webkit系ブラウザ用 */
      /* 
      scrollbar-width: thin; 
      scrollbar-color: #ccc transparent; 

      &::-webkit-scrollbar {
        width: 8px;
      }

      &::-webkit-scrollbar-track {
        background: transparent;
      }

      &::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 4px;
        border: 2px solid transparent;
      }
      */      
    }
    
    /* モバイルビュー用のスタイル */
    @media screen and (max-width: 768px) {
      #infobox-container {
        max-height: 50vh; /* ビューポートの高さの60%に設定 */
        /* 必要に応じてパディングやマージンを調整 */
        padding: 8px;
        margin: 5px auto;
      }
    }    

    /* 検索コンテナ */
    .search-container {
      position: relative;
      display: inline-block;
    }

    /* propertyContainer の入力欄（info-iconあり） */
    #propertyContainer .search-container input {
        padding: 6px 35px 6px 35px; /* 両側にアイコンのスペース */
        border: 1px solid grey;
        border-radius: 15px;
        font-size: 16px;
        z-index: 3001;
    }

    .info-icon {
      position: absolute;
      left: 8px;
      top: 18%;
      transform: translateY(-0%);
      width: 20px;
      height: 20px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s, transform 0.3s;
    }

    .info-icon:hover {
      opacity: 1;
      transform: scale(1.2);
    }

    .clear-icon {
      position: absolute;
      right: 8px;
      top: 14%;
      transform: translateY(-0%);
      width: 23px;
      height: 23px;
      cursor: pointer;
      display: none;
      opacity: 0.7;
      transition: opacity 0.3s, transform 0.3s;
    }

    .clear-icon:hover {
      opacity: 1;
      transform: scale(1.2);
    }

    .search-container:has(input:not(:placeholder-shown)) .clear-icon {
      display: block;
    }

    /* カスタムファイル入力 */
    .custom-file-input {
        color: #333;
        font-size: 20px;
        margin-right: 0px;
        display: inline-block;
        padding: 4px 12px;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.3s;
    }

    .custom-file-input:hover {
        background-color: #ddd;
    }

    #fileInput { display: none; }

    /* 地図スタイル */
    #map {
      flex: 1;
      position: relative;
      height: calc(var(--vh, 1svh) * 100);
      width: 100%;
      z-index: 0;
    }

    /* ボタンスタイル */
    #currentLocationBtn, #layerToggleBtn {
      position: fixed;
      z-index: 1000;
      cursor: pointer;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
      background: none;
      border: none;
    }

    #currentLocationBtn {
        top: 70px;
        right: 20px;
    }

    #layerToggleBtn {
        top: 21px;
        right: 20px;
    }

    #currentLocationBtn:hover, #layerToggleBtn:hover {
        transform: scale(1.2);
    }

    #currentLocationBtn img, #layerToggleBtn img {
        width: 30px;
        height: 30px;
    }
    

    /* Zoom Controls Container */
    .zoom-container {
      position: fixed;
      /* bottom: 20px; @media 設定*/
      right: 11px; /* Initial position: bottom right */
      display: flex;
      flex-direction: column;
      gap: 0px;
      z-index: 1000;
      /* background: rgba(255, 255, 255, 0.8); */
      /* border-radius: 15px; */
      padding: 5px;
      /* box-shadow: 0 2px 6px rgba(0,0,0,0.3); */
    }

    /* Zoom Buttons */
    .zoom-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: transform 0.3s ease;
      font-size: 23px;
      color: rgba(0, 25, 60, 0.6);
    }

    .zoom-btn:hover {
      transform: scale(1.2);
    }

    /* Adjust icon size if necessary */
    .zoom-btn i {
      pointer-events: none; /* Prevent click events on the icon itself */
    }

    /* Transition for moving the container */
    /* @media 設定
    .zoom-container.moved-left {
      right: auto;
      left: 52px;
    }
    */
    

    /* 物件コンテナ */
    #propertyContainer {
      position: fixed;
      top: 15px; 
      width: 320px;
      max-height: 70vh; 
      background-color: transparent;
      z-index: 3001;
      border: 0px solid #ccc;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      pointer-events: auto;
      touch-action: pan-y; 
      overscroll-behavior: contain;
    }

    /* モバイル用 */
    #propertyContainer { left: 15px; }

    /* デスクトップ用 */
    @media screen and (min-width: 769px) {
      #propertyContainer { left: 60px; }
    }

    #propertySearchHeader {
      background: transparent;
      padding: 5px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      align-items: center;
    }

    #propertySearchHeader input {
      flex: 1;
      min-width: 0;
      padding: 6px 10px;
      border: 1px solid grey;
      border-radius: 15px;
      font-size: 16px;
    }

    #propertySearchHeader button {
      padding: 5px 10px;
      cursor: pointer;
      background: none;
      border: none;
      color: #555;
      transition: color 0.3s;
      font-size: 18px;
    }

    #propertySearchHeader button:hover {
      color: #333;
    }

    /* 更新されたローディングスピナー */
    .loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 1001;
      display: none; /* 初期状態では非表示 */
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    /* アニメーションの定義 */
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* モーダルウィンドウのスタイル */
    .modal {
      display: none;
      position: fixed; 
      z-index: 3000; /* 既存のz-indexより上 */
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%;
      overflow: auto; 
      background-color: rgba(0,0,0,0.4); /* 半透明の背景 */
    }

    .modal-content {
      background-color: #fefefe;
      font-size: 12px;
      margin: 70px auto; /* 上下中央に配置 */
      padding: 20px;
      border: 1px solid #888;
      width: 90%; /* 幅を調整 */
      max-width: 800px; /* 最大幅を設定 */
      border-radius: 10px;
      position: relative;
    }

    .close-button {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 10px;
    }

    .tab-button {
      background-color: inherit;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: background-color 0.3s;
      font-size: 17px;
    }

    .tab-button:hover {
      background-color: #ddd;
    }

    .tab-button.active {
      background-color: #ccc;
    }

    .tab-content {
      max-height: 60vh;
      overflow-y: auto;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    #propertyListArea {
      flex: 1;
      overflow-y: auto;
      padding: 5px 10px;
      border: none;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    #propertyListArea.hidden { display: none; }

    ul { list-style: none; margin: 0; padding: 0; }

    li { border-bottom: 1px solid #ccc; padding: 3px 0; }

    li:last-child { border-bottom: none; }

    .property-name {
      color: #007bff;
      text-decoration: underline;
      cursor: pointer;
    }

    .property-name:hover { color: #0056b3; }

    /* ブリンキングマーカー */
    @keyframes blink {
      0%   { opacity:1; }
      50%  { opacity:0; }
      100% { opacity:1; }
    }

    .blinking-marker {
      width: 14px;
      height: 14px;
      background-color: magenta;
      border: 2px solid white;
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    /* ローディングスピナーの表示 */
    .loading {
      display: block;
    }

    /* オートコンプリート候補リストのスタイル */
    .autocomplete-suggestions {
      position: absolute;
      margin-top: 5px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      z-index: 1002;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: none; /* 初期状態では非表示 */
    }

    .autocomplete-suggestion {
      padding: 8px 12px;
      cursor: pointer;
    }

    .autocomplete-suggestion:hover,
    .autocomplete-suggestion.active {
      background-color: #f0f0f0;
    }

    .autocomplete-suggestion .highlight {
      font-weight: bold;
      background-color: yellow;
    }

  </style>
</head>

<body>
  <!-- 地図コンテナ -->
  <div id="map" tabindex="0" aria-label="Map Area"></div>

  <!-- レイヤートグルボタン -->
  <button id="layerToggleBtn" role="button" aria-label="Toggle Map Layer" title="Toggle Map Layer">
      <img src="https://img.icons8.com/?size=100&id=2m4kkop8aUO5&format=png&color=000000" alt="Toggle Layer Icon" />
  </button>        
  
  <!-- 現在位置ボタン -->
  <button id="currentLocationBtn" onclick="toggleCurrentLocation()" aria-label="Toggle Current Location" title="Toggle Current Location">
      <img src="https://img.icons8.com/?size=100&id=ziC1TV1ikKi9&format=png&color=004ACD4D" alt="Show Location" />
  </button>

  <!-- Zoom Controls -->
  <div id="zoomContainer" class="zoom-container" aria-label="Zoom Controls">
    <button id="moveZoomBtn" class="zoom-btn" aria-label="Move Zoom Controls" title="Move Zoom Controls">
      <i class="fa-solid fa-caret-left"></i>
    </button>
    <button id="zoomInBtn" class="zoom-btn" aria-label="Zoom In" title="Zoom In">
      <i class="fa-solid fa-circle-plus"></i>
    </button>
    <button id="zoomOutBtn" class="zoom-btn" aria-label="Zoom Out" title="Zoom Out">
      <i class="fa-solid fa-circle-minus"></i>
    </button>
  </div>   
  
  <!-- メニュートグルボタン -->
  <button id="menuToggleBtn" class="menu-toggle" aria-label="Toggle Menu" title="Toggle Menu">
    ☰
  </button>        
  
  <!-- 物件コンテナ（検索ボックスとリスト） -->
  <div id="propertyContainer">
    <div id="propertySearchHeader">
      <!-- 物件検索ボックス -->
      <div class="search-container" style="position: relative;">
        <input
          type="text"
          id="propertySearchBox"
          placeholder="Property search"
          aria-label="Property Search Box"
          autocomplete="off"
        />
        <img
          src="https://img.icons8.com/?size=100&id=80585&format=png&color=000000"
          alt="Info"
          class="info-icon"
          onclick="openInfoModal()"
          aria-label="Show Search Information"
        />          
        <img
          src="https://img.icons8.com/?size=100&id=121477&format=png&color=75750399"
          alt="Clear"
          class="clear-icon"
          onclick="clearPropertySearch()"
          aria-label="Clear Property Search"
        />
        <!-- オートコンプリート候補リスト -->
        <div id="autocompleteList" class="autocomplete-suggestions" role="listbox" aria-label="Search Suggestions"></div>
      </div>
      <!-- リスト表示トグルボタン -->
      <button onclick="toggleList()" aria-label="Toggle Property List" title="Toggle Property List">
        <i id="toggleIcon" class="fa-solid fa-angles-down" style="color: #555"></i>
      </button>        
    </div>

    <!-- ローディングスピナー -->
    <div class="loading-spinner" id="propertyLoadingSpinner" aria-hidden="true"></div>

    <div id="propertyListArea" class="hidden">
      <ul id="propertyResultUl"></ul>
    </div>
  </div>  

  <!-- ローディングスピナー（地理検索用） -->
  <div class="loading-spinner" id="geoLoadingSpinner" aria-hidden="true"></div>
  

  <!-- モーダルウィンドウ -->
  <div id="infoContainer" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span class="close-button" onclick="closeInfoModal()" aria-label="Close Modal">&times;</span>
      <div class="tabs">
        <button class="tab-button active" onclick="openTab('searchResult')">Search Result</button>
        <button class="tab-button" onclick="openTab('searchTips')">Search Tips</button>
      </div>
      <div class="tab-content">
        <div id="searchResult" class="tab-panel active">
          <!-- searchResult情報がここに表示されます -->
          <p></p>
  
        </div>
        <div id="searchTips" class="tab-panel">
          <!-- searchTips情報がここに表示されます -->
          <p>
            1. Simple Search<br>

            Purpose: Quickly find properties by name, address, or general keywords.<br>

            How to Use:<br>
            1.	Locate the Search Box:<br>
            　•	On the Property Container panel, find the search box labeled “Property search.”<br>
            2.	Enter Your Query:<br>
　            •	Click on the search box and type in the name of the property, its address, or any related keyword.<br>
            　•	Example Inputs:<br>
              •	Sunset Villas<br>
              •	123 Maple Street<br>
              •	Eco-friendly Apartments<br>
            3.	Execute the Search:<br>
              •	Press the Enter key on your keyboard.<br>
              •	The map will display markers and polygons representing the matching properties.<br>
              •	A list of results will appear below the search box for easy reference.<br>
            4.	View Property Details:<br>
              •	Click on a property name in the results list to zoom into its location on the map.<br>
              •	Alternatively, click directly on a map marker or polygon to view detailed information about the property.<br>
            5.	Clear the Search:<br>
              •	Click the clear icon (✖) inside the search box to remove your query and reset the search results.<br>
            <br>
            Tips:<br>
              •	Use specific names or addresses for the best results.<br>
              •	The search is case-insensitive, so sunset villas and Sunset Villas yield the same results.<br>  
          </p>
        </div>
      </div>
    </div>
  </div>  

  <!-- メニューコンテナ -->
  <div id="menuContainer" class="menu closed" role="navigation" aria-label="Main Menu">
    <div class="menu-header" id="menuDragHandle">
      <div class="drag-handle" aria-hidden="true"></div>
    </div>
    <div class="menu-content">
      <div id="top-bar">
        <!-- 地域検索ボックス -->
        <div class="search-container">
          <img
            src="https://img.icons8.com/?size=100&id=MkFMsOJRAJYW&format=png&color=000000"
            alt="Unions"
            class="union-icon"
            onclick="openUnionList()"
            aria-label="Show Union List"
          />              
          <input
            type="text"
            id="geoSearchBox"
            placeholder="Enter a place"
            aria-label="Geographical Search Box"
          />
          <img
            src="https://img.icons8.com/?size=100&id=121477&format=png&color=75750399"
            alt="Clear"
            class="clear-icon"
            onclick="clearGeoSearch()"
            aria-label="Clear Geographical Search"
          />

          <!-- ドロップダウンリストを追加 -->
          <div id="regionDropdown" class="region-dropdown" role="menu" aria-label="Region and Union List">
            <ul>
              <li tabindex="0" data-value="ASIA">Asia</li>
              <li tabindex="0" data-value="Oceania">Oceania</li>
              <li tabindex="0" data-value="NorthAmerica">North America</li>
              <li tabindex="0" data-value="CentralSouthAmerica">Central & South America</li>
              <li tabindex="0" data-value="Europe">Europe</li>
              <li tabindex="0" data-value="Africa">Africa</li>
              <li tabindex="0" data-value="MiddleEast">Middle East</li>
              <li tabindex="0" data-value="ASEAN">ASEAN</li>
              <li tabindex="0" data-value="EU">EU</li>
              <li tabindex="0" data-value="G7">G7</li>
              <li tabindex="0" data-value="G20">G20</li>
              <li tabindex="0" data-value="NATO">NATO</li>
              <li tabindex="0" data-value="OECD">OECD</li>
              <li tabindex="0" data-value="BRICS">BRICS</li>
              <li tabindex="0" data-value="MERCOSUR">MERCOSUR</li>
              <!-- 必要に応じて他の地域も追加 -->
            </ul>
          </div>         
          
        </div>
        <!-- ファイル入力 -->
        <label for="fileInput" class="custom-file-input" tabindex="0" aria-label="Upload Excel File">
          <i class="fa-solid fa-file-arrow-down"></i>
        </label>
        <input type="file" id="fileInput" accept=".xls,.xlsx,.xlsm" aria-hidden="true" />
      </div>      

      <!-- Wikipedia Infobox 表示コンテナ（追加） -->
      <div id="infobox-container" aria-live="polite"></div>

      <ul>
        <li><a href="#option1" tabindex="0">Option 1</a></li>
        <li><a href="#option2" tabindex="0">Option 2</a></li>
        <li><a href="#option3" tabindex="0">Option 3</a></li>
      </ul>
    </div>
  </div>

  <script type="module">
    // JavaScriptモジュールの開始
    (() => {
      // -------------------------------------------------------
      // 1) Initialize Leaflet map
      // -------------------------------------------------------
      const map = L.map('map', {
          zoomControl: false, // ズームボタンを非表示にする
          minZoom: 2, // 最小ズームレベルを制限
          maxZoom: 18, // 最大ズームレベルを制限  
          worldCopyJump: true
      }).setView([1, 125], 3);　   // Center of Asia Oceania     
   // }).setView([16, 105], 5);　  // Center of Vietnam
   // }).setView([54, 15], 4);　   // Center of Europe
   // }).setView([54, -105], 3);　 // Center of North America 
   // }).setView([11, -89], 5);　  // Center of Central South America     
   // }).setView([32, 35], 5);　   // Center of Midde East     
   // }).setView([3, 16], 3);　    // Center of Africa

      // 地図の最大表示範囲を設定（余白ができないようにする）
      const bounds = L.latLngBounds(
          L.latLng(-85, -Infinity), // 南西端
          L.latLng(85, Infinity)    // 北東端
      );
      map.on('drag', function () {
          map.panInsideBounds(bounds, { animate: false });
      });      


      // ダブルクリックズームを無効化
      map.doubleClickZoom.disable();

      // ダブルクリック時にパン
      map.on('dblclick', (e) => {
        map.panTo(e.latlng, { animate: true });
      });


      // OSMの標準タイルレイヤーを追加
      const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // サテライトビュー（ダミーとしてOSMを再度使用）
      const satelliteLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      });

      // 初期レイヤーを地図に追加
      streetLayer.addTo(map);

      let isSatellite = false; // 現在のレイヤーフラグ

      // レイヤートグルボタンのクリックイベント
      const toggleBtn = document.getElementById('layerToggleBtn');
      toggleBtn.addEventListener('click', () => {
        toggleMapLayer();
      });

      // レイヤートグルボタンのキーボードイベント
      toggleBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleMapLayer();
        }
      });

      /**
       * マップレイヤーの切り替え関数
       */
      function toggleMapLayer() {
        if (isSatellite) {
            map.removeLayer(satelliteLayer);
            map.addLayer(streetLayer);
            toggleBtn.querySelector('img').src = "https://img.icons8.com/?size=100&id=2m4kkop8aUO5&format=png&color=000000"; // ストリートアイコン
            toggleBtn.querySelector('img').alt = "Switch to Satellite View";
        } else {
            map.removeLayer(streetLayer);
            map.addLayer(satelliteLayer);
            toggleBtn.querySelector('img').src = "https://img.icons8.com/?size=100&id=NHtRhybXwxli&format=png&color=000000"; // 衛星アイコン
            toggleBtn.querySelector('img').alt = "Switch to Street View";
        }
        isSatellite = !isSatellite; // 状態を切り替える
      }

      // 地図の操作を有効化
      map.dragging.enable();
      map.scrollWheelZoom.enable();

      // プロパティコンテナへのポインタ/タッチイベントで地図操作を無効化
      const propertyPanel = document.getElementById('propertyContainer');
      propertyPanel.addEventListener('pointerenter', () => {
        map.dragging.disable();
        map.scrollWheelZoom.disable();
      });
      propertyPanel.addEventListener('pointerleave', () => {
        map.dragging.enable();
        map.scrollWheelZoom.enable();
      });
      propertyPanel.addEventListener('touchstart', () => {
        map.dragging.disable();
        map.scrollWheelZoom.disable();
      });
      propertyPanel.addEventListener('touchend', () => {
        map.dragging.enable();
        map.scrollWheelZoom.enable();
      });

      // -------------------------------------------------------
      // 2) Excel reading (all columns)
      // -------------------------------------------------------
      let propertyData = [];
      const fileInput = document.getElementById('fileInput');

      fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        closeUIElements();

        try {
          // ローディングスピナーを表示
          showLoadingSpinner('propertyLoadingSpinner');

          const data = await readExcelFile(file);
          propertyData = parseExcelData(data);

          console.log("Excel loaded:", propertyData.length, "rows");
          alert("Excel loaded: " + propertyData.length + " properties found.");

          // オートコンプリートのデータを更新
          initializeAutocomplete();
        } catch (error) {
          console.error("Error loading Excel file:", error);
          alert("Failed to load Excel file. Please ensure the file is valid.");
        } finally {
          // ローディングスピナーを非表示
          hideLoadingSpinner('propertyLoadingSpinner');
        }
      });

      /**
       * Excelファイルを読み込む非同期関数
       * @param {File} file - ユーザーがアップロードしたファイル
       * @returns {Promise} - Excelデータの配列
       */
      async function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const sheetName = workbook.SheetNames[0];
              const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
              resolve(jsonData);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = () => {
            reject(new Error("Failed to read the file."));
          };
          reader.readAsArrayBuffer(file);
        });
      }

      /**
       * Excelデータをパースして物件データ配列を作成する関数
       * ここで新たに Country / Region / Data Name / Administrative Division / Local Authority / Street を追加
       * @param {Array} data - Excelから読み込まれたデータ
       * @returns {Array} - パースされた物件データ
       */
      function parseExcelData(data) {
        return data.map(row => ({
          pjName:       row["PJ name"]        || "",
          address:      row["Address"]        || "",
          category1:    row["Category 1"]     || "",
          category2:    row["Category 2"]     || "",
          developer:    row["Developer"]      || "",
          architect:    row["Architect"]      || "",
          contractor:   row["Contractor"]     || "",
          salesCompany: row["Sales Company"]  || "",
          status:       row["Status"]         || "",
          siteArea:     row["Site Area"]      || "",
          latitude:     parseFloat(row["Latitude"]   || "NaN"),
          longitude:    parseFloat(row["Longitude"]  || "NaN"),

          // 追加カラム
          country:                row["Country"]                 || "",
          region:                 row["Region"]                  || "",
          dataName:               row["Data Name"]               || "",
          administrativeDivision: row["Administrative Division"] || "",
          localAuthority:         row["Local Authority"]         || "",
          street:                 row["Street"]                  || ""
        }));
      }

      // -------------------------------------------------------
      // 3) Arrays for markers & polygons
      // -------------------------------------------------------
      const propertyMarkers = [];
      const propertyPolygons = [];

      // -------------------------------------------------------
      // 4) handlePropertySearch
      // -------------------------------------------------------
      const propertySearchBox = document.getElementById('propertySearchBox');

      propertySearchBox.addEventListener('keydown', async (event) => {
          if (event.key === 'Enter') {
              await handlePropertySearch();
          }
      });

      /**
       * 物件検索処理
       */
      async function handlePropertySearch() {
        const query = propertySearchBox.value.trim();
        if (!query) {
          alert("Please enter a property search query.");
          return;
        }

        closeUIElements();

        try {
          // ローディングスピナーを表示
          showLoadingSpinner('propertyLoadingSpinner');

          // 既存のマーカーとポリゴンを削除
          propertyMarkers.forEach(m => map.removeLayer(m));
          propertyMarkers.length = 0;
          propertyPolygons.forEach(p => map.removeLayer(p));
          propertyPolygons.length = 0;

          const ul = document.getElementById('propertyResultUl');
          ul.innerHTML = "";

          // 簡易検索を使用
          const results = simpleSearch(propertyData, query);
          if (results.length === 0) {
            alert("No matching properties found.");
            return;
          }

          const searchBounds = L.latLngBounds();

          results.forEach((item) => {
            const li = document.createElement('li');
            const nameSpan = document.createElement('span');
            nameSpan.className = "property-name";
            nameSpan.textContent = item.pjName || "(No Name)";
            nameSpan.onclick = () => zoomToItem(item);
            nameSpan.setAttribute('tabindex', '0');
            nameSpan.setAttribute('role', 'button');
            nameSpan.setAttribute('aria-pressed', 'false');
            nameSpan.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                zoomToItem(item);
              }
            });
            li.appendChild(nameSpan);
            ul.appendChild(li);

            if (!isNaN(item.latitude) && !isNaN(item.longitude)) {
              const marker = createMarkerWithCategoryStyle(item);
              propertyMarkers.push(marker);
              searchBounds.extend(marker.getLatLng());
            }
            if (item.siteArea) {
              try {
                const coords = JSON.parse(item.siteArea);
                if (Array.isArray(coords) && coords.length >= 3) {
                  const polygon = createPolygonWithCategoryStyle(item, coords);
                  propertyPolygons.push(polygon);
                  searchBounds.extend(polygon.getBounds());
                }
              } catch(e) {
                console.warn("Invalid siteArea for", item.pjName, e);
              }
            }
          });

          if (searchBounds.isValid()) {
            map.fitBounds(searchBounds, { padding: [20, 20] });
          }
        } catch (error) {
          console.error("Error during property search:", error);
          alert("An error occurred during the search. Please try again.");
        } finally {
          // ローディングスピナーを非表示
          hideLoadingSpinner('propertyLoadingSpinner');
        }
      }

      /**
       * マーカー作成関数
       * @param {Object} item - 物件データ
       * @returns {Object} - Leafletマーカー
       */
      function createMarkerWithCategoryStyle(item) {
          const latLng = [item.latitude, item.longitude];
          let customIcon = getCategoryIcon(item.category1);

          const marker = L.marker(latLng, { icon: customIcon }).addTo(map);
          marker.bindPopup(buildPopup(item));
          return marker;
      }

      // カテゴリーごとのアイコンサイズを定義するマッピング
      const categoryIconSizes = {
          'primary': [15, 15],
          'area': [0, 0],
          'haseko': [20, 20],
          'ecoba': [20, 20],
          'condominium': [15, 15],
          'others': [20, 20],
          'pj site': [0, 0],
          'default': [20, 20] // デフォルトサイズ
      };     

      /**
       * カテゴリに応じたアイコン取得
       * @param {String} cat - カテゴリ名
       * @returns {Object} - Leafletアイコン
       */
      function getCategoryIcon(cat) {
          const size = categoryIconSizes[cat.toLowerCase()] || categoryIconSizes['default'];
          return L.icon({
              iconUrl: chooseCategoryIconUrl(cat),
              iconSize: size, // カテゴリーごとのサイズを適用
              iconAnchor: [size[0] / 2, size[1] / 2], // アイコンのアンカーを中央に設定
              popupAnchor: [0, -size[1] / 2]
          });
      }

      /**
       * アイコンURL選択関数
       * @param {String} cat - カテゴリ名
       * @returns {String} - アイコンのURL
       */
      function chooseCategoryIconUrl(cat) {
          switch (cat.toLowerCase()) {
              case 'primary':      return 'https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=571601B8';
              case 'area':         return 'https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=1A529300'; /*透明=非表示*/
              case 'haseko':       return 'https://img.icons8.com/?size=100&id=uRRFz0DH6uYw&format=png&color=000000';
              case 'ecoba':        return 'https://img.icons8.com/?size=100&id=59830&format=png&color=4BAA8EA8';
              case 'condominium':  return 'https://img.icons8.com/?size=30&id=24801&format=png&color=FF2E1754';
              case 'others':       return 'https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=0046b099';
              case 'pj site':      return 'https://img.icons8.com/?size=100&id=ipgAkdE46kxu&format=png&color=000000';
              default:             return 'https://maps.google.com/mapfiles/ms/icons/black-dot.png';
          }
      }

      /**
       * ポリゴン作成関数
       * @param {Object} item - 物件データ
       * @param {Array} coords - ポリゴンの座標
       * @returns {Object} - Leafletポリゴン
       */
      function createPolygonWithCategoryStyle(item, coords) {
        const polygonStyle = getCategoryPolygonStyle(item.category1);
        const polygon = L.polygon(coords, polygonStyle).addTo(map);
        polygon.bindPopup(buildPopup(item));
        polygon.on('click', () => polygon.openPopup());
        return polygon;
      }

      /**
       * カテゴリに応じたポリゴンスタイル取得
       * @param {String} cat - カテゴリ名
       * @returns {Object} - ポリゴンスタイル
       */
      function getCategoryPolygonStyle(cat) {
        switch (cat.toLowerCase()) {
          case 'primary':      return { color: 'none', fillColor: 'blue', fillOpacity: 0.2 };
          case 'area':         return { color: 'none', fillColor: 'gold', fillOpacity: 0.2 };
          case 'haseko':       return { color: 'none', fillColor: 'orange', fillOpacity: 0.2 };
          case 'ecoba':        return { color: 'none', fillColor: 'purple', fillOpacity: 0.2 };
          case 'condominium':  return { color: 'none', fillColor: 'red', fillOpacity: 0.2 };
          case 'others':       return { color: 'none', fillColor: 'yellow', fillOpacity: 0.2 };
          case 'pj site':      return { color: 'none', fillColor: 'grey', fillOpacity: 0.2 };
          default:             return { color: 'none', fillColor: 'black', fillOpacity: 0.2 };
        }
      }

      /**
       * アイテムにズーム
       * @param {Object} item - 物件データ
       */
      function zoomToItem(item) {
          // ポリゴン（siteArea）がある場合の処理
          if (item.siteArea) {
              try {
                  const coords = JSON.parse(item.siteArea);
                  if (Array.isArray(coords) && coords.length >= 3) {
                      const tempPoly = L.polygon(coords);
                      map.fitBounds(tempPoly.getBounds(), { padding: [20, 20] });
                      return; // ポリゴンが存在する場合はここで処理終了
                  }
              } catch (e) {
                  console.warn("Invalid siteArea format:", e);
              }
          }

          // 緯度・経度が有効な場合の処理
          if (!isNaN(item.latitude) && !isNaN(item.longitude)) {
              const targetLatLng = [item.latitude, item.longitude];
              const zoomLevel = 17; // ズームレベルを変更可能

              // アニメーション付きズーム（flyToを利用）
              map.flyTo(targetLatLng, zoomLevel);
          } else {
              console.warn("Invalid coordinates for item:", item);
          }
      }

      /**
       * ポップアップ内容構築
       * ※ ポップアップには今回追加の6カラムは表示しない
       * @param {Object} item - 物件データ
       * @returns {String} - HTMLコンテンツ
       */
      function buildPopup(item) {
        return `
          <strong>${item.pjName}</strong><br>
          Address: ${item.address}<br>
          Category1: ${item.category1}<br>
          Category2: ${item.category2}<br>
          Developer: ${item.developer}<br>
          Architect: ${item.architect}<br>
          Contractor: ${item.contractor}<br>
          Sales Company: ${item.salesCompany}<br>
          Status: ${item.status}<br>
        `;
      }

      // -------------------------------------------------------
      // 5) Show/Hide List
      // -------------------------------------------------------
      /**
       * リスト表示の切り替え関数
       */
      function toggleList() {
        const listArea = document.getElementById('propertyListArea');
        const toggleIcon = document.getElementById('toggleIcon');  // アイコンを取得

        if (listArea.classList.contains('hidden')) {
            listArea.classList.remove('hidden');
            toggleIcon.classList.remove('fa-angles-down');  // "down"アイコンを削除
            toggleIcon.classList.add('fa-angles-up');   // "up"アイコンを追加
        } else {
            listArea.classList.add('hidden');
            toggleIcon.classList.remove('fa-angles-up');  // "up"アイコンを削除
            toggleIcon.classList.add('fa-angles-down');       // "down"アイコンを追加
        }
      }

      // -------------------------------------------------------
      // 6) Simple Search
      // -------------------------------------------------------
      /**
       * 簡易検索関数
       * @param {Array} data - 物件データ
       * @param {String} rawQuery - ユーザーのクエリ
       * @returns {Array} - 検索結果
       */
      function simpleSearch(data, rawQuery) {
        // サポートする形式: "hai hong" da nang -someword
        // 引用符で囲まれたフレーズを単一トークンとして扱う

        // 正規表現で引用符内のフレーズを抽出
        const regex = /"([^"]+)"|(\S+)/g;
        const tokens = [];
        let match;
        while ((match = regex.exec(rawQuery.toLowerCase())) !== null) {
          if (match[1]) {
            tokens.push(match[1]); // 引用符内のフレーズ
          } else {
            tokens.push(match[2]); // 単一の単語
          }
        }

        const notWords = tokens.filter(t => t.startsWith("-")).map(t => t.slice(1));
        const andWords = tokens.filter(t => !t.startsWith("-") && t !== "and" && t !== "or");

        /**
         * アイテムのテキストを構築
         * ※ 新たに追加した6カラムも検索対象に含める
         * @param {Object} item - 物件データ
         * @returns {String} - 結合されたテキスト
         */
        function buildText(item) {
          const combined = [
            item.pjName,
            item.address,
            item.category1,
            item.category2,
            item.developer,
            item.architect,
            item.contractor,
            item.salesCompany,
            item.status,
            item.siteArea,

            // 追加分
            item.country,
            item.region,
            item.dataName,
            item.administrativeDivision,
            item.localAuthority,
            item.street
          ].join(" ").toLowerCase().replace(/\s+/g, " ");
          return combined;
        }

        let idxSet = new Set(data.map((_, i) => i));
        // AND条件
        andWords.forEach(w => {
          idxSet = new Set([...idxSet].filter(idx => {
            const txt = buildText(data[idx]);
            return txt.includes(w);
          }));
        });
        // NOT条件
        notWords.forEach(n => {
          idxSet.forEach(idx => {
            const txt = buildText(data[idx]);
            if (txt.includes(n)) {
              idxSet.delete(idx);
            }
          });
        });
        return [...idxSet].map(i => data[i]);
      }

      // -------------------------------------------------------
      // 7) Complex Search (parentheses, AND/OR/NOT, : = > >=)
      // -------------------------------------------------------
      // 複雑な検索機能を削除しました。

      // -------------------------------------------------------
      // 8) handleGeoSearch (Nominatim)
      // -------------------------------------------------------
      let boundaryLayer = null;
      let maskLayer = null;

      const geoSearchBox = document.getElementById('geoSearchBox');

      geoSearchBox.addEventListener('keydown', async (event) => {
          if (event.key === 'Enter') {
              await handleGeoSearch();
          }
      });

      /**
       * 地域検索処理
       */
      async function handleGeoSearch() {
        const q = geoSearchBox.value.trim();
        if (!q) {
          alert("Please enter a place name.");
          return;
        }

        closeUIElements();

        try {
          // ローディングスピナーを表示
          showLoadingSpinner('geoLoadingSpinner');

          // 既存のレイヤーを削除
          if (boundaryLayer) map.removeLayer(boundaryLayer);
          if (maskLayer) map.removeLayer(maskLayer);

          // Nominatim APIを使用して地理情報を取得
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&polygon_geojson=1`;
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network response was not ok.");
          const data = await response.json();

          if (!data.length) {
            alert("No matching location found.");
            return;
          }

          const result = data[0];

          if (result.geojson) {
            // 境界線を描画
            boundaryLayer = L.geoJSON(result.geojson, {
              style: {
                color: '#FF000DA8',
                weight: 1.7,
                opacity: 1,
                fillOpacity: 0,
                dashArray: '2, 3'
              }
            }).addTo(map);

            // マスクレイヤーを作成　（アジア中心）
            const mapBounds = map.getBounds();
            const worldBounds = [
              [
                [-90, 360],   // 最南端, 東端
                [90, 360],    // 最北端, 東端
                [90, -360],   // 最北端, 西端
                [-90, -360],  // 最南端, 西端
                [-90, 360]    // 多角形を閉じる
              ]
            ];

            if (result.geojson.type === 'Polygon') {
              worldBounds.push(result.geojson.coordinates[0].map(p => [p[1], p[0]]).reverse());
            } else if (result.geojson.type === 'MultiPolygon') {
              result.geojson.coordinates.forEach(poly => {
                worldBounds.push(poly[0].map(p => [p[1], p[0]]).reverse());
              });
            }

            maskLayer = L.polygon(worldBounds, {
              color: 'none',
              fillColor: '#000',
              fillOpacity: 0.1
            }).addTo(map);
            maskLayer.bringToBack();

            // 地図を境界に合わせる
            map.fitBounds(boundaryLayer.getBounds(), { padding: [20, 20] });
          } else {
            // 境界がない場合は中心点に移動
            map.setView([result.lat, result.lon], 13);
          }

          // Nominatim検索後にWikipedia Infoboxを呼び出す
          await searchWiki(q);
          
        } catch(e) {
          console.error(e);
          alert("Search failed. Please try again.");
        } finally {
          // ローディングスピナーを非表示
          hideLoadingSpinner('geoLoadingSpinner');
        }
      }

      /**
       * 地理検索ボックスをクリアする関数
       */
      function clearGeoSearch() {
        geoSearchBox.value = '';

        // 検索結果をクリアする（既存の地理検索結果レイヤーを削除）
        if (boundaryLayer) {
          map.removeLayer(boundaryLayer);
          boundaryLayer = null;
        }
        if (maskLayer) {
          map.removeLayer(maskLayer);
          maskLayer = null;
        }
      }

      /**
       * 物件検索ボックスをクリアする関数
       */
      function clearPropertySearch() {
        propertySearchBox.value = '';

        // 検索結果をクリアする（マーカーとポリゴンを削除）
        propertyMarkers.forEach(marker => map.removeLayer(marker));
        propertyMarkers.length = 0;

        propertyPolygons.forEach(polygon => map.removeLayer(polygon));
        propertyPolygons.length = 0;

        const ul = document.getElementById('propertyResultUl');
        ul.innerHTML = "";

        // オートコンプリート候補もクリア
        const autocompleteList = document.getElementById('autocompleteList');
        autocompleteList.innerHTML = "";
        autocompleteList.style.display = 'none';
      }

      // -------------------------------------------------------
      // **) Close UI Elements
      // -------------------------------------------------------
      /**
       * UI要素を閉じる関数
       */
      function closeUIElements() {
        const menuContainer = document.getElementById('menuContainer');
        const listArea = document.getElementById('propertyListArea');
        const mapElement = document.getElementById('map');

        // 携帯表示（モバイル用クラス）
        if (window.innerWidth < 769) {
            if (menuContainer) {
                menuContainer.classList.remove('full', 'half');
                menuContainer.classList.add('closed'); // スライドダウン
            }
        } 
        // PC表示（スタイル変更）
        else {
            if (menuContainer) {
                menuContainer.style.transform = 'translateX(-400px)'; // メニューを隠す
            }
        }

        // 物件リストを非表示にする
        if (listArea) {
            listArea.classList.add('hidden');
        }

        // モバイルキーボードを閉じる
        document.activeElement.blur();

        // 地図にフォーカスを移動
        if (mapElement) {
            mapElement.focus();
        }
      }

      // -------------------------------------------------------
      // 9) Real-time Current Location
      // -------------------------------------------------------
      let currentLocMarker = null;
      let watchID = null;
      let trackingActive = false;

      const currentLocationBtn = document.getElementById('currentLocationBtn');

      currentLocationBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleCurrentLocation();
        }
      });

      /**
       * 現在位置の追跡を切り替える関数
       */
      function toggleCurrentLocation() {
        const btnIcon = document.querySelector('#currentLocationBtn img'); // ボタン内のアイコン画像を取得

        if (!trackingActive) {
            // リアルタイム追跡を開始
            if (!navigator.geolocation) {
              alert("Geolocation is not supported by this browser.");
              return;
            }
            watchID = navigator.geolocation.watchPosition(
              positionSuccess,
              positionError,
              { enableHighAccuracy: true }
            );
            btnIcon.src = "https://img.icons8.com/?size=100&id=ziC1TV1ikKi9&format=png&color=004ACD99"; // 追跡中のアイコン
            btnIcon.alt = "Tracking Current Location";
            trackingActive = true;
        } else {
            // リアルタイム追跡を停止
            if (watchID !== null) {
              navigator.geolocation.clearWatch(watchID);
              watchID = null;
            }
            if (currentLocMarker) {
              map.removeLayer(currentLocMarker);
              currentLocMarker = null;
            }
            btnIcon.src = "https://img.icons8.com/?size=100&id=ziC1TV1ikKi9&format=png&color=004ACD63"; // 停止中のアイコン
            btnIcon.alt = "Stop Tracking Location";
            trackingActive = false;
        }
      }

      /**
       * 現在位置取得成功時のコールバック
       * @param {Object} pos - GeolocationPositionオブジェクト
       */
      function positionSuccess(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        console.log("Current position:", lat, lng);

        // マーカーがまだ作成されていない場合、作成
        if (!currentLocMarker) {
            const divIcon = L.divIcon({
              html: '<div class="blinking-marker"></div>',
              className: '',
              iconSize: [18, 18],
              iconAnchor: [9, 9]
            });
            currentLocMarker = L.marker([lat, lng], { icon: divIcon }).addTo(map);
        } else {
            // 位置を更新
            currentLocMarker.setLatLng([lat, lng]);
        }

        // 現在位置にスムーズに移動
        map.flyTo([lat, lng], 16);
      }

      /**
       * 現在位置取得失敗時のコールバック
       * @param {Object} err - GeolocationPositionErrorオブジェクト
       */
      function positionError(err) {
        console.error("Geolocation error:", err);
        alert("Failed to get current location: " + err.message);
      }

      // -------------------------------------------------------
      // 10) Menu Container 改善
      // -------------------------------------------------------
      document.addEventListener('DOMContentLoaded', () => {
        const menuContainer = document.getElementById('menuContainer');
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const menuDragHandle = document.getElementById('menuDragHandle');

        // PC用の状態管理
        let isMenuOpen = false;
        let isHovering = false;

        // モバイル用の状態管理
        let startY = 0;
        let isDragging = false;

        // デバイスチェック関数
        const isPCView = () => window.innerWidth >= 769;

        /**
         * メニューの位置を更新する関数
         * @param {Number} position - メニューのX位置
         */
        function updateMenuPosition(position) {
          if (isPCView()) {
            menuContainer.style.transform = `translateX(${position}px)`;
          }
        }

        /**
         * メニュートグルボタンのクリックイベントハンドラ
         * @param {Event} e - クリックイベント
         */
        function handleMenuToggle(e) {
          if (isPCView()) {
            e.stopPropagation();
            isMenuOpen = !isMenuOpen;
            updateMenuPosition(isMenuOpen ? 0 : -400); /* default -320 */
            menuToggleBtn.innerHTML = isMenuOpen ? '&times;' : '☰';
            menuToggleBtn.setAttribute('aria-pressed', isMenuOpen);
          }
        }

        /**
         * メニュー外クリック時にメニューを閉じる関数
         * @param {Event} e - クリックイベント
         */
        function handleDocumentClick(e) {
          if (isPCView() && isMenuOpen && 
              !menuContainer.contains(e.target) && 
              e.target !== menuToggleBtn) {
            isMenuOpen = false;
            updateMenuPosition(-400); /* default -320 */
            menuToggleBtn.innerHTML = '☰';
            menuToggleBtn.setAttribute('aria-pressed', isMenuOpen);
          }
        }

        /**
         * メニューコンテナのホバーイベントハンドラ
         */
        function handleMenuHover() {
          if (isPCView() && !isMenuOpen) {
            isHovering = true;
            updateMenuPosition(-400); /* default -320 */
          }
        }

        /**
         * メニューコンテナのホバー終了イベントハンドラ
         */
        function handleMenuHoverEnd() {
          if (isPCView() && !isMenuOpen) {
            isHovering = false;
            updateMenuPosition(-400); /* default -320 */
          }
        }

        /**
         * メニューコンテナのクリックイベントハンドラ
         * @param {Event} e - クリックイベント
         */
        function handleMenuClick(e) {
          if (isPCView() && !isMenuOpen && isHovering) {
            isMenuOpen = true;
            updateMenuPosition(0);
            menuToggleBtn.innerHTML = '&times;';
            menuToggleBtn.setAttribute('aria-pressed', isMenuOpen);
            e.stopPropagation();
          }
        }

        /**
         * モバイル用のメニュードラッグイベントハンドラ
         * @param {TouchEvent} e - タッチイベント
         */
        function handleMenuDragStart(e) {
          if (!isPCView()) {
            startY = e.touches[0].clientY;
            isDragging = true;
          }
        }

        /**
         * モバイル用のメニュードラッグ移動イベントハンドラ
         * @param {TouchEvent} e - タッチイベント
         */
        function handleMenuDragMove(e) {
          if (!isDragging || isPCView()) return;
          const currentY = e.touches[0].clientY;
          const deltaY = currentY - startY;

          if (deltaY > 50) {
            setMenuState('closed');
          } else if (deltaY > -50 && deltaY < 50) {
            setMenuState('half');
          } else if (deltaY < -50) {
            setMenuState('full');
          }
        }

        /**
         * モバイル用のメニュードラッグ終了イベントハンドラ
         */
        function handleMenuDragEnd() {
          if (!isPCView()) {
            isDragging = false;
          }
        }

        /**
         * メニューの状態を設定する関数
         * @param {String} state - 'closed', 'half', 'full'
         */
        function setMenuState(state) {
          if (!isPCView()) {
            menuContainer.classList.remove('closed', 'half', 'full');
            menuContainer.classList.add(state);
          }
        }

        // メニュートグルボタンにイベントリスナーを追加
        if (menuToggleBtn) {
          menuToggleBtn.addEventListener('click', handleMenuToggle);
          menuToggleBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleMenuToggle(e);
            }
          });
        }

        // ドキュメント全体にクリックイベントリスナーを追加
        document.addEventListener('click', handleDocumentClick);

        // メニューコンテナにホバーイベントリスナーを追加
        if (menuContainer) {
          menuContainer.addEventListener('mouseenter', handleMenuHover);
          menuContainer.addEventListener('mouseleave', handleMenuHoverEnd);
          menuContainer.addEventListener('click', handleMenuClick);
        }

        // メニューコンテナにドラッグイベントリスナーを追加
        if (menuDragHandle) {
          menuDragHandle.addEventListener('touchstart', handleMenuDragStart);
          menuDragHandle.addEventListener('touchmove', handleMenuDragMove);
          menuDragHandle.addEventListener('touchend', handleMenuDragEnd);
        }
   
          /**
           * Add by Sako
           * 物件リスト外クリックでリスト閉じる
           */        
          // ドキュメント全体のクリックを監視してリストを閉じる
          document.addEventListener('click', (event) => {
            const propertyContainer = document.getElementById('propertyContainer'); // 物件コンテナ
            const propertyListArea = document.getElementById('propertyListArea'); // 物件リスト

            // クリックした箇所が物件コンテナの外で、リストが表示されている場合
            if (!propertyContainer.contains(event.target) && !propertyListArea.classList.contains('hidden')) {
              toggleList(); // 既存のリストを閉じる関数を呼び出す
            }
          });
          

        // リサイズイベントに対応
        window.addEventListener('resize', () => {
          if (isPCView()) {
            updateMenuPosition(isMenuOpen ? 0 : -400); /* default -320 */
            menuContainer.classList.remove('closed', 'half', 'full');
          } else {
            menuContainer.style.transform = '';
            menuContainer.classList.add('closed');
            isMenuOpen = false;
            isHovering = false;
          }
        });
      });

      // -------------------------------------------------------
      // 11) Utility Functions
      // -------------------------------------------------------
      /**
       * ローディングスピナーを表示する関数
       * @param {String} spinnerId - スピナーのID
       */
      function showLoadingSpinner(spinnerId) {
        const spinner = document.getElementById(spinnerId);
        if (spinner) {
          spinner.classList.add('loading');
          spinner.setAttribute('aria-hidden', 'false');
        }
      }

      /**
       * ローディングスピナーを非表示にする関数
       * @param {String} spinnerId - スピナーのID
       */
      function hideLoadingSpinner(spinnerId) {
        const spinner = document.getElementById(spinnerId);
        if (spinner) {
          spinner.classList.remove('loading');
          spinner.setAttribute('aria-hidden', 'true');
        }
      }

      // -------------------------------------------------------
      // 12) Expose Functions to Global Scope
      // -------------------------------------------------------
      // これらの関数をグローバルスコープに公開する
      window.clearGeoSearch = clearGeoSearch;
      window.clearPropertySearch = clearPropertySearch;
      window.toggleCurrentLocation = toggleCurrentLocation;
      window.toggleList = toggleList;
      window.openInfoModal = openInfoModal;
      window.closeInfoModal = closeInfoModal;
      window.openTab = openTab;
      
      // -------------------------------------------------------
      // 13) Custom Zoom Controls
      // -------------------------------------------------------
      (() => {
        // Ensure the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
          // Select Zoom Controls Elements
          const zoomContainer = document.getElementById('zoomContainer');
          const moveZoomBtn = document.getElementById('moveZoomBtn');
          const zoomInBtn = document.getElementById('zoomInBtn');
          const zoomOutBtn = document.getElementById('zoomOutBtn');

          // Track the current position: true = right, false = left
          let isRight = true;

          // Function to toggle zoom container position
          function toggleZoomPosition() {
            if (isRight) {
              // Move to left
              zoomContainer.classList.add('moved-left');
              zoomContainer.classList.remove('moved-right');
              moveZoomBtn.innerHTML = '<i class="fa-solid fa-caret-right"></i>';
            } else {
              // Move to right
              zoomContainer.classList.remove('moved-left');
              zoomContainer.classList.add('moved-right');
              moveZoomBtn.innerHTML = '<i class="fa-solid fa-caret-left"></i>';
            }
            isRight = !isRight;
          }

          // Event Listener for Move Button
          moveZoomBtn.addEventListener('click', toggleZoomPosition);
          moveZoomBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              toggleZoomPosition();
            }
          });

          // Event Listener for Zoom In Button
          zoomInBtn.addEventListener('click', () => {
            map.zoomIn();
          });
          zoomInBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              map.zoomIn();
            }
          });

          // Event Listener for Zoom Out Button
          zoomOutBtn.addEventListener('click', () => {
            map.zoomOut();
          });
          zoomOutBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              map.zoomOut();
            }
          });

          // Optional: Keyboard shortcuts for zooming
          map.on('keydown', (e) => {
            if (e.key === '+') {
              map.zoomIn();
            } else if (e.key === '-') {
              map.zoomOut();
            }
          });
        });
      })();
    

      // -------------------------------------------------------
      // 14) Modal Control Functions
      // -------------------------------------------------------
      /**
       * Opens the Info Modal
       */
      function openInfoModal() {
        const modal = document.getElementById('infoContainer');
        if (modal) {
          modal.style.display = 'block';
          modal.setAttribute('aria-hidden', 'false');
          
          // Optionally, set focus to the modal for accessibility
          const closeButton = modal.querySelector('.close-button');
          if (closeButton) closeButton.focus();
          
          // Add event listener for Escape key to close modal
          document.addEventListener('keydown', handleEscapeKey);
        }
      }

      /**
       * Closes the Info Modal
       */
      function closeInfoModal() {
        const modal = document.getElementById('infoContainer');
        if (modal) {
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
          
          // Optionally, return focus to the info-icon for accessibility
          const infoIcon = document.querySelector('.info-icon');
          if (infoIcon) infoIcon.focus();
          
          // Remove event listener for Escape key
          document.removeEventListener('keydown', handleEscapeKey);
        }
      }

      /**
       * Handles tab switching within the modal
       * @param {String} tabName - The ID of the tab to open
       */
      function openTab(tabName) {
        const tabs = document.querySelectorAll('.tab-button');
        const panels = document.querySelectorAll('.tab-panel');

        tabs.forEach(tab => {
          if (tab.getAttribute('onclick') === `openTab('${tabName}')`) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });

        panels.forEach(panel => {
          if (panel.id === tabName) {
            panel.classList.add('active');
          } else {
            panel.classList.remove('active');
          }
        });
      }

      /**
       * Handles closing the modal when the Escape key is pressed
       * @param {KeyboardEvent} event 
       */
      function handleEscapeKey(event) {
        if (event.key === 'Escape') {
          closeInfoModal();
        }
      }

      /**
       * Initializes modal event listeners
       */
      function initializeModal() {
        const modal = document.getElementById('infoContainer');
        if (modal) {
          // Close modal when clicking outside the modal content
          window.addEventListener('click', function(event) {
            if (event.target === modal) {
              closeInfoModal();
            }
          });
        }
      }

      // Initialize modal functionalities when DOM is fully loaded
      document.addEventListener('DOMContentLoaded', initializeModal);      



      // -------------------------------------------------------
      // 15) Region Search Functionality
      // -------------------------------------------------------

      // 地域と国のマッピング
      const regionCountryMap = {
        // Resions
        "ASIA": ["Japan", "China", "India", "South Korea", "North Korea", "Indonesia", "Malaysia", "Thailand", "Vietnam", "Philippines", "Singapore", "Taiwan", "Hong Kong"],
        "Oceania": ["Australia", "New Zealand", "Fiji", "Papua New Guinea", "Samoa", "Solomon Islands", "Vanuatu", "Kiribati", "Micronesia", "Marshall Islands", "Palau", "Tuvalu", "Nauru", "Cook Islands", "Niue"],
        "NorthAmerica": ["United States", "Canada", "Mexico", "Belize", "Costa Rica", "Panama", "El Salvador", "Honduras", "Guatemala", "Cuba", "Bahamas", "Barbados", "Antigua and Barbuda", "Dominica", "Grenada", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Trinidad and Tobago"],
        "CentralSouthAmerica": ["Argentina", "Bolivia", "Brazil", "Chile", "Colombia", "Ecuador", "Peru", "Venezuela", "Paraguay", "Uruguay", "Suriname"],
        "Europe": ["Albania", "Andorra", "Austria", "Belarus", "Belgium", "Bosnia and Herzegovina", "Bulgaria", "Croatia", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Iceland", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Moldova", "Monaco", "Montenegro", "Netherlands", "Norway", "Poland", "Portugal", "Romania", "Russia", "San Marino", "Serbia", "Slovakia", "Slovenia", "Spain", "Sweden", "Switzerland", "Ukraine", "United Kingdom", "Vatican City"],
        "Africa": ["Algeria", "Angola", "Benin", "Botswana", "Burkina Faso", "Burundi", "Cameroon", "Central African Republic", "Chad", "Comoros", "Congo", "Côte d'Ivoire", "Djibouti", "Egypt", "Eritrea", "Eswatini", "Ethiopia", "Gabon", "Gambia", "Ghana", "Guinea", "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar", "Malawi", "Mali", "Mauritania", "Mauritius", "Morocco", "Mozambique", "Namibia", "Niger", "Nigeria", "Rwanda", "Senegal", "Seychelles", "Sierra Leone", "Somalia", "South Africa", "Sudan", "South Sudan", "Tanzania", "Togo", "Uganda", "Zambia", "Zimbabwe"],
        "MiddleEast": ["Bahrain", "Iran", "Iraq", "Israel", "Jordan", "Kuwait", "Lebanon", "Oman", "Qatar", "Saudi Arabia", "Syria", "Turkey", "United Arab Emirates"],
        // Unions
        "ASEAN": ["Brunei Darussalam", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Vietnam"],
        "EU": ["Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden"],
        "G7": ["Canada", "France", "Germany", "Italy", "Japan", "United Kingdom", "United States"],
        "G20": ["Argentina", "Australia", "Brazil", "Canada", "China", "France", "Germany", "India", "Indonesia", "Italy", "Japan", "Mexico", "Russia", "Saudi Arabia", "South Africa", "South Korea", "Turkey", "United Kingdom", "United States", "European Union"],
        "NATO": ["Albania", "Belgium", "Bulgaria", "Canada", "Croatia", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Iceland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Montenegro", "Netherlands", "North Macedonia", "Norway", "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Turkey", "United Kingdom", "United States"],
        "OECD": ["Australia", "Austria", "Belgium", "Canada", "Chile", "Colombia", "Costa Rica", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Iceland", "Ireland", "Israel", "Italy", "Japan", "South Korea", "Latvia", "Lithuania", "Luxembourg", "Mexico", "Netherlands", "New Zealand", "Norway", "Poland", "Portugal", "Slovak Republic", "Slovenia", "Spain", "Sweden", "Switzerland", "Turkey", "United Kingdom", "United States"],
        "BRICS": ["Brazil", "Russia", "India", "China", "South Africa"],
        "MERCOSUR": ["Argentina", "Brazil", "Paraguay", "Uruguay", "Venezuela"]
      };

      // 地域ごとの色設定
      const regionColors = {
        // Resions
        "ASIA": "#1f78b4",
        "Oceania": "#1f78b4",
        "NorthAmerica": "#1f78b4",
        "CentralSouthAmerica": "#1f78b4",
        "Europe": "#1f78b4",
        "Africa": "#1f78b4",
        "MiddleEast": "#1f78b4",
        // Unions
        "ASEAN": "#33a02c",
        "EU": "#33a02c",
        "G7": "#33a02c",
        "G20": "#33a02c",
        "NATO": "#33a02c",
        "OECD": "#33a02c",
        "BRICS": "#33a02c",
        "MERCOSUR": "#33a02c",
      };

      // 地域検索用のレイヤー
      let countriesLayer = null;
      let currentHighlightedRegions = [];
      
      // オリジナルの regionDropdown の HTML を保持する変数
      let originalRegionDropdownHTML = '';

      /**
       * 地域検索を処理する関数
       * @param {String} selectedRegion - 選択された地域またはユニオン
       */
      async function handleRegionSearch(selectedRegion) {
        // 既存のハイライトをクリア
        clearRegionHighlights();

        if (!selectedRegion) {
          alert("Please select a region.");
          return;
        }

        const countries = regionCountryMap[selectedRegion];
        if (!countries || countries.length === 0) {
          alert("No countries found for the selected region.");
          return;
        }

        try {
          // ローディングスピナーを表示
          showLoadingSpinner('propertyLoadingSpinner');

          // GeoJSONデータをロード
          const geoData = await fetchCountriesGeoJSON();

          // 地域に属する国々をフィルタリング
          const selectedCountriesGeoJSON = {
            type: "FeatureCollection",
            features: geoData.features.filter(feature => {
              const countryName = feature.properties.ADMIN || feature.properties.NAME;
              return countries.includes(countryName);
            })
          };

          // レイヤーを作成
          if (countriesLayer) {
            map.removeLayer(countriesLayer);
          }

          countriesLayer = L.geoJSON(selectedCountriesGeoJSON, {
            style: {
              color: regionColors[selectedRegion] || '#000000',
              weight: 1,
              fillOpacity: 0.3
            },
            onEachFeature: function (feature, layer) {
              layer.bindPopup(`<strong>${feature.properties.ADMIN || feature.properties.NAME}</strong>`);
            }
          }).addTo(map);

          currentHighlightedRegions.push(selectedRegion);

          // 地図の表示範囲を調整
          const bounds = countriesLayer.getBounds();
          map.fitBounds(bounds, { padding: [50, 50] });

          // 選択した地域を geoSearchBox に表示
          displaySelectedRegion(selectedRegion);

          // Infobox検索を実行
          await searchWiki(selectedRegion);

        } catch (error) {
          console.error("Error during region search:", error);
          alert("An error occurred during the region search. Please try again.");
        } finally {
          // ローディングスピナーを非表示
          hideLoadingSpinner('propertyLoadingSpinner');
        }
      }


      /**
       * 選択された地域を geoSearchBox に表示する関数
       * @param {String} selectedRegion - 選択された地域名
       */
      function displaySelectedRegion(selectedRegion) {
        const searchBox = document.getElementById('geoSearchBox');
        if (searchBox) {
          searchBox.value = selectedRegion;

          // 地図のハイライトは既に handleRegionSearch 内で行われているため、ここでは追加の処理は不要
        }
      }
      
      /**
       * 地理検索ボックスをクリアする関数
       */
      function clearGeoSearch() {
        // geoSearchBox をクリア
        const geoSearchBox = document.getElementById('geoSearchBox');
        if (geoSearchBox) {
          geoSearchBox.value = '';
        }

        // 検索結果をクリアする（既存の地理検索結果レイヤーを削除）
        if (boundaryLayer) {
          map.removeLayer(boundaryLayer);
          boundaryLayer = null;
        }
        if (maskLayer) {
          map.removeLayer(maskLayer);
          maskLayer = null;
        }

        // 地物マーカーとポリゴンをクリアする
        propertyMarkers.forEach(marker => map.removeLayer(marker));
        propertyMarkers.length = 0;

        propertyPolygons.forEach(polygon => map.removeLayer(polygon));
        propertyPolygons.length = 0;

        // プロパティ検索結果のリストをクリア
        const ul = document.getElementById('propertyResultUl');
        if (ul) {
          ul.innerHTML = "";
        }

        // オートコンプリート候補もクリア
        const autocompleteList = document.getElementById('autocompleteList');
        if (autocompleteList) {
          autocompleteList.innerHTML = "";
          autocompleteList.style.display = 'none';
        }

        // 選択された地域をクリアする
        clearRegionSelection();

        // Infobox をクリアする
        clearInfobox();
      }

      /**
       * Infobox をクリアする関数
       */
      function clearInfobox() {
        const infoboxContainer = document.getElementById('infobox-container');
        if (infoboxContainer) {
          infoboxContainer.innerHTML = ""; // またはデフォルトのメッセージを設定
          infoboxContainer.setAttribute('aria-hidden', 'true'); // アクセシビリティ対応
        }
      }



      /**
       * 地域ハイライトをクリアし、geoSearchBox をリセットする関数
       */
      function clearRegionSelection() {
        // 地図上のハイライトをクリア
        clearRegionHighlights();

        const regionDropdown = document.getElementById('regionDropdown');
        if (regionDropdown && originalRegionDropdownHTML) {
          // regionDropdown の内容をオリジナルに戻す
          regionDropdown.innerHTML = originalRegionDropdownHTML;

          // 再度イベントリスナーを初期化
          initializeDropdownEvents();
        }
      }

      
      /**
       * 地域ハイライトをクリアし、regionDropdown をリセットする関数
       */
      function clearRegionSelection() {
        // 地図上のハイライトをクリア
        clearRegionHighlights();

        const regionDropdown = document.getElementById('regionDropdown');
        if (regionDropdown && originalRegionDropdownHTML) {
          // regionDropdown の内容をオリジナルに戻す
          regionDropdown.innerHTML = originalRegionDropdownHTML;

          // 再度イベントリスナーを初期化
          initializeDropdownEvents();
        }
      }      
      
      /**
       * GeoJSONデータを取得する関数
       * @returns {Promise<Object>} - GeoJSONデータ
       */
      async function fetchCountriesGeoJSON() {
        const response = await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
        if (!response.ok) {
          throw new Error("Failed to fetch GeoJSON data.");
        }
        const data = await response.json();
        return data;
      }
      
      /**
       * 地域ハイライトをクリアする関数
       */
      function clearRegionHighlights() {
        if (countriesLayer) {
          map.removeLayer(countriesLayer);
          countriesLayer = null;
        }
        currentHighlightedRegions = [];
      }      
      

      // -------------------------------------------------------
      // 17) Expose Functions to Global Scope (Updated)
      // -------------------------------------------------------
      // これらの関数をグローバルスコープに公開する
      window.clearGeoSearch = clearGeoSearch;
      window.clearPropertySearch = clearPropertySearch;
      window.toggleCurrentLocation = toggleCurrentLocation;
      window.toggleList = toggleList;
      window.openInfoModal = openInfoModal;
      window.closeInfoModal = closeInfoModal;
      window.openTab = openTab;
      window.handleRegionSearch = handleRegionSearch;
      window.clearRegionHighlights = clearRegionHighlights;
      window.clearRegionSelection = clearRegionSelection; // 新たに追加

      // -------------------------------------------------------
      // 18) Wikipedia Infobox Parser (追加)
      // -------------------------------------------------------
      /**
       * Wikipedia Infoboxを検索・表示する関数
       * @param {String} term - 検索語
       */
      async function searchWiki(term) {
        term = term.trim();
        if (!term) {
          alert("Please enter a search term.");
          return;
        }

        // Wikipediaの検索APIエンドポイント
        const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(term)}&format=json&origin=*`;

        try {
          // 検索リクエストを送信
          const searchRes = await fetch(searchUrl);
          if (!searchRes.ok) {
            throw new Error("API request failed."); // エラー処理
          }

          const searchData = await searchRes.json();

          // 検索結果が存在するか確認
          if (searchData.query.search.length === 0) {
            document.getElementById("infobox-container").innerHTML = "No results found for your search term.";
            document.getElementById("infobox-container").setAttribute('aria-hidden', 'true');
            return;
          }

          // 最初の検索結果を取得
          const pageTitle = searchData.query.search[0].title;

          // Infoboxを取得するためのAPIエンドポイント
          const infoboxUrl = `https://en.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(pageTitle)}&format=json&prop=text&origin=*`;

          // Infoboxのリクエストを送信
          const infoboxRes = await fetch(infoboxUrl);
          if (!infoboxRes.ok) {
            throw new Error("API request failed."); // エラー処理
          }

          const infoboxData = await infoboxRes.json();

          // ページが存在しない場合やエラー時は data.error とか data.parse が無いことがある
          if (!infoboxData.parse || !infoboxData.parse.text) {
            document.getElementById("infobox-container").innerHTML = "Page not found or parse error occurred.";
            document.getElementById("infobox-container").setAttribute('aria-hidden', 'true');
            return;
          }

          // Wikipedia HTML (ページ全体) を取得
          const htmlString = infoboxData.parse.text["*"];

          // HTML文字列をDOMに変換
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlString, "text/html");

          // infoboxっぽいtableを探す
          // en.wikipedia の場合、class="infobox" になっていることが多い
          const infobox = doc.querySelector("table.infobox");

          if (infobox) {
            // 必要に応じてこのまま表示、あるいは内部をさらに解析
            const infoboxContainer = document.getElementById("infobox-container");
            if (infoboxContainer) {
              infoboxContainer.innerHTML = infobox.outerHTML;
              infoboxContainer.setAttribute('aria-hidden', 'false');
            }
          } else {
            const infoboxContainer = document.getElementById("infobox-container");
            if (infoboxContainer) {
              infoboxContainer.innerHTML = "No infobox found.";
              infoboxContainer.setAttribute('aria-hidden', 'true');
            }
          }

        } catch (error) {
          console.error(error);
          const infoboxContainer = document.getElementById("infobox-container");
          if (infoboxContainer) {
            infoboxContainer.innerHTML = "An error occurred while fetching the data.";
            infoboxContainer.setAttribute('aria-hidden', 'true');
          }
        }
      }


      
      // -------------------------------------------------------
      // 17) Autocomplete Functionality Initialization
      // -------------------------------------------------------
      let autocompleteData = []; // Array to hold unique searchable terms

      /**
       * Initializes autocomplete by extracting unique searchable terms from propertyData
       * ここで追加カラムも含めて検索候補に含める
       */
      function initializeAutocomplete() {
        autocompleteData = [];

        propertyData.forEach(item => {
          // Extract searchable fields
          const searchableFields = [
            item.pjName,
            item.address,
            item.category1,
            item.category2,
            item.developer,
            item.architect,
            item.contractor,
            item.salesCompany,
            item.status,

            // 追加分
            item.country,
            item.region,
            item.dataName,
            item.administrativeDivision,
            item.localAuthority,
            item.street
          ];

          // Include both individual terms and entire phrases
          searchableFields.forEach(field => {
            if (field) {
              const lowerField = field.toLowerCase();
              // Add the entire field as a term (for multi-word keywords)
              if (!autocompleteData.includes(lowerField)) {
                autocompleteData.push(lowerField);
              }
              // Split into individual words and add them
              const terms = lowerField.split(/\s+/);
              terms.forEach(term => {
                if (!autocompleteData.includes(term)) {
                  autocompleteData.push(term);
                }
              });
            }
          });
        });

        setupAutocomplete();
      }

      /**
       * Sets up autocomplete event listeners and logic
       */
      function setupAutocomplete() {
        const searchBox = document.getElementById('propertySearchBox');
        const autocompleteList = document.getElementById('autocompleteList');
        let currentFocus = -1;

        // Debounce function to limit the rate of function calls
        function debounce(func, delay) {
          let debounceTimer;
          return function(...args) {
            const context = this;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
          }
        }

        // Function to close all autocomplete lists
        function closeAllLists() {
          autocompleteList.innerHTML = "";
          autocompleteList.style.display = 'none';
          currentFocus = -1;
        }

        // Function to highlight matched text
        function highlightMatch(text, match) {
          const index = text.toLowerCase().indexOf(match.toLowerCase());
          if (index !== -1) {
            return text.substring(0, index) +
                   '<span class="highlight">' + text.substring(index, index + match.length) + '</span>' +
                   text.substring(index + match.length);
          }
          return text;
        }

        // Function to generate autocomplete suggestions
        function generateSuggestions(value) {
          const trimmedValue = value.trim().toLowerCase();
          if (!trimmedValue) {
            closeAllLists();
            return;
          }

          const suggestions = autocompleteData.filter(term => term.startsWith(trimmedValue)).slice(0, 10); // Limit to 10 suggestions

          autocompleteList.innerHTML = "";
          if (suggestions.length === 0) {
            autocompleteList.style.display = 'none';
            return;
          }

          suggestions.forEach(suggestion => {
            const suggestionDiv = document.createElement('div');
            suggestionDiv.classList.add('autocomplete-suggestion');
            suggestionDiv.setAttribute('role', 'option');
            suggestionDiv.innerHTML = highlightMatch(suggestion, trimmedValue);
            suggestionDiv.addEventListener('click', () => {
              searchBox.value = suggestion;
              closeAllLists();
              handlePropertySearch(); // Execute search immediately after selection
            });
            autocompleteList.appendChild(suggestionDiv);
          });

          autocompleteList.style.display = 'block';
        }

        // Debounced input handler
        const debouncedInput = debounce(function() {
          generateSuggestions(this.value);
        }, 300); // 300ms delay

        searchBox.addEventListener('input', debouncedInput);

        // Keyboard navigation
        searchBox.addEventListener('keydown', function(e) {
          let items = autocompleteList.getElementsByClassName('autocomplete-suggestion');
          if (e.key === 'ArrowDown') {
            currentFocus++;
            addActive(items);
          } else if (e.key === 'ArrowUp') {
            currentFocus--;
            addActive(items);
          } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentFocus > -1) {
              if (items[currentFocus]) {
                items[currentFocus].click();
              }
            }
          } else if (e.key === 'Escape') {
            closeAllLists();
          }
        });

        function addActive(items) {
          if (!items) return false;
          removeActive(items);
          if (currentFocus >= items.length) currentFocus = 0;
          if (currentFocus < 0) currentFocus = items.length - 1;
          items[currentFocus].classList.add('active');
          // Scroll into view if necessary
          items[currentFocus].scrollIntoView({ block: 'nearest' });
        }

        function removeActive(items) {
          for (let i = 0; i < items.length; i++) {
            items[i].classList.remove('active');
          }
        }

        // Close the autocomplete list when clicking outside
        document.addEventListener('click', function (e) {
          if (e.target !== searchBox) {
            closeAllLists();
          }
        });

        // Accessibility: ARIA roles are already set in the HTML and JavaScript above
      }

      // -------------------------------------------------------
      // **) Additional Enhancements
      // -------------------------------------------------------      
      /**
       * Define openUnionList function to toggle the regionDropdown
       */
      function openUnionList() {
        const dropdown = document.getElementById('regionDropdown');
        if (dropdown) {
          dropdown.classList.toggle('show');
        }
      }

      // Expose openUnionList to global scope
      window.openUnionList = openUnionList;

      // -------------------------------------------------------
      // 19) Handle Dropdown Item Selection
      // -------------------------------------------------------
      /**
       * ドロップダウンリスト内の項目をクリックした際のイベントリスナーを追加
       */
      function initializeDropdownEvents() {
        const dropdownItems = document.querySelectorAll('#regionDropdown li');
        dropdownItems.forEach(item => {
          item.addEventListener('click', () => {
            const value = item.getAttribute('data-value');
            if (value) {
              handleRegionSearch(value);
              document.getElementById('regionDropdown').classList.remove('show');
            }
          });

          // キーボードでの操作を可能にする
          item.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              const value = item.getAttribute('data-value');
              if (value) {
                handleRegionSearch(value);
                document.getElementById('regionDropdown').classList.remove('show');
              }
            }
          });
        });
      }



      // ドロップダウンリスト外をクリックした際にリストを閉じる
      function initializeDropdownOutsideClick() {
        document.addEventListener('click', (e) => {
          const dropdown = document.getElementById('regionDropdown');
          const unionIcon = document.querySelector('.union-icon');
          if (dropdown && !dropdown.contains(e.target) && e.target !== unionIcon) {
            dropdown.classList.remove('show');
          }
        });
      }

      // -------------------------------------------------------
      // 16) Initialize Functions on DOM Content Loaded
      // -------------------------------------------------------
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize Dropdown Events
        initializeDropdownEvents();
        initializeDropdownOutsideClick();

        // オリジナルの regionDropdown の HTML を保持
        const regionDropdown = document.getElementById('regionDropdown');
        if (regionDropdown) {
          originalRegionDropdownHTML = regionDropdown.innerHTML;
        }
      });

      // -------------------------------------------------------
      // **) Additional Enhancements
      // -------------------------------------------------------
      function handleOrientationChange() {
        if (window.matchmedia("(orientation: portait)").matches) {
          document.body.style.width = "100%";
        } else if (window.matchmedia("(orientation: landscape)").matches) {
          document.body.style.width = "100vw";
        }
      }

      window.addEventListener("orientationchange", handleOrientationChange);
      window.addEventListener("resize", handleOrientationChange);
      handleOrientationChange();      

      // -------------------------------------------------------
      // **) Additional Enhancements
      // -------------------------------------------------------
      // 既存のコードを尊重し、オートコンプリート機能の追加以外の機能やデザインは一切変更していません。

    })();
  </script>
</body>
</html>
